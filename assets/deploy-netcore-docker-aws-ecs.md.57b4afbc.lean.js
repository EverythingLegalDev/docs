import{_ as n,c as s,o as r,a as o,b as e,e as t}from"./app.da189b1e.js";const R='{"title":"Deploy .NET Core with Docker to EC2 Container Service","description":"","frontmatter":{"slug":"deploy-netcore-docker-aws-ecs","title":"Deploy .NET Core with Docker to EC2 Container Service"},"headers":[{"level":2,"title":"Native Docker Integration in the Cloud","slug":"native-docker-integration-in-the-cloud"},{"level":2,"title":"AWS EC2 Container Service","slug":"aws-ec2-container-service"},{"level":2,"title":"Deploying to AWS Container Service Overview","slug":"deploying-to-aws-container-service-overview"},{"level":3,"title":"Deploying fork of redis-geo .NET Core App","slug":"deploying-fork-of-redis-geo-net-core-app"},{"level":3,"title":"Running build scripts locally","slug":"running-build-scripts-locally"},{"level":3,"title":"Walkthrough Overview","slug":"walkthrough-overview"},{"level":2,"title":"1. Create the ecsInstanceRole Role","slug":"_1-create-the-ecsinstancerole-role"},{"level":2,"title":"2. Create a new IAM User","slug":"_2-create-a-new-iam-user"},{"level":2,"title":"Checkout AWS Container Service","slug":"checkout-aws-container-service"},{"level":2,"title":"3. Launch new EC2 Docker Server Instance","slug":"_3-launch-new-ec2-docker-server-instance"},{"level":2,"title":"Revisit AWS Container Service","slug":"revisit-aws-container-service"},{"level":2,"title":"4. Associating Elastic IP to new EC2 Instance","slug":"_4-associating-elastic-ip-to-new-ec2-instance"},{"level":2,"title":"Assign a Domain Name to your Elastic IP","slug":"assign-a-domain-name-to-your-elastic-ip"},{"level":2,"title":"5. Log into the new EC2 Instance","slug":"_5-log-into-the-new-ec2-instance"},{"level":3,"title":"Enable support for SSL","slug":"enable-support-for-ssl"},{"level":2,"title":"6. Fork redis-geo Demo","slug":"_6-fork-redis-geo-demo"},{"level":3,"title":"Inspect the Build Scripts","slug":"inspect-the-build-scripts"},{"level":3,"title":"ECS task-definition.json","slug":"ecs-task-definition-json"},{"level":2,"title":"Configure support for SSL","slug":"configure-support-for-ssl"},{"level":2,"title":"Create project in Travis-CI","slug":"create-project-in-travis-ci"},{"level":3,"title":"CI Environment Variables","slug":"ci-environment-variables"},{"level":2,"title":"Inspect AWS Container Service","slug":"inspect-aws-container-service"},{"level":3,"title":"View list of running Docker Containers","slug":"view-list-of-running-docker-containers"},{"level":2,"title":"Problems with the task not running","slug":"problems-with-the-task-not-running"},{"level":2,"title":"8. Play your deployed .NET Core Docker App!","slug":"_8-play-your-deployed-net-core-docker-app"},{"level":2,"title":"Things to try","slug":"things-to-try"},{"level":3,"title":"1. Make a change to your App","slug":"_1-make-a-change-to-your-app"},{"level":3,"title":"2. Go through this tutorial again","slug":"_2-go-through-this-tutorial-again"},{"level":3,"title":"3. Copy the build scripts to Dockerize own .NET Core Apps","slug":"_3-copy-the-build-scripts-to-dockerize-own-net-core-apps"},{"level":3,"title":"4. Exec build scripts to Create and Run your Docker App locally","slug":"_4-exec-build-scripts-to-create-and-run-your-docker-app-locally"}],"relativePath":"deploy-netcore-docker-aws-ecs.md","lastUpdated":1651073975539}',a={},i=o('',94),c=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,"chmod 400 ~/pem/ecs-demo.pem")])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),l=e("p",null,[t("Once locked down you can use it to SSH into your instance using the "),e("code",null,"-i"),t(" flag, logging in as the "),e("code",null,"ec2-user"),t(":")],-1),p=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,[t("ssh -i ~/pem/ecs-demo.pem "),e("a",{href:"mailto:ec2-user@ecsdemo.netcore.io"},"ec2-user@ecsdemo.netcore.io")])])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),h=e("p",null,[t("Replace "),e("code",null,"ecsdemo.netcore.io"),t(" with your domain name or Elastic IP. If everything went to plan you should now be logged into your EC2 Instance:")],-1),d=e("p",null,[e("img",{src:"https://docs.servicestack.net/images/aws/ecs/ssh-01.png",alt:""})],-1),u=e("p",null,[t("We're only assigned one task while we're here which is to run an instance of the "),e("code",null,"jwilder/nginx-proxy"),t(" Docker App copying the command below:")],-1),g=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,"docker run -d -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy")])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),k=o('',7),w=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,[t("docker run --detach --name nginx-proxy --publish 80:80 --publish 443:443 "),e("br"),t(" --volume /etc/nginx/certs --volume /etc/nginx/vhost.d --volume /usr/share/nginx/html "),e("br"),t(" --volume /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy")])])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),m=e("p",null,[t("You'll also need to run the "),e("a",{href:"https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion",target:"_blank",rel:"noopener noreferrer"},"letsencrypt-nginx-proxy-companion"),t(" companion Docker container for "),e("code",null,"nginx-proxy"),t(" with:")],-1),y=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,[t("docker run --detach --name nginx-proxy-letsencrypt --volumes-from nginx-proxy "),e("br"),t(" --volume /var/run/docker.sock:/var/run/docker.sock:ro jrcs/letsencrypt-nginx-proxy-companion")])])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),f=o('',8),v=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,"C:\\src\\redis-geo>code .")])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),b=o(`__VP_STATIC_START__<p>The <code>.travis.yml</code> is used to configure the environment which <strong>Travis CI</strong> will execute your build under. Here we&#39;re telling Travis we want a <strong>csharp</strong> environment for our solution located at <strong>src/RedisGeo.sln</strong> using an Ubuntu 14.04 Linux distribution with .NET Core installed. The <strong>script</strong> section tells Travis how it should build our project, which is to just run the build scripts in the repo:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/code-01.png" alt=""></p><p>The <code>DockerFile</code> tells Docker how to build our Docker App Image:</p><ul><li>that&#39;s based on the <strong>microsoft/dotnet:latest</strong> Docker Image from Docker&#39;s public Repository</li><li>includes a copy of our .NET Core solution files</li><li>runs <code>dotnet restore</code> on to pull down all NuGet dependencies</li><li>builds the .NET Core Solutions <strong>Host Project</strong> using <code>dotnet build</code></li><li>notifies Docker our App will run a TCP Service listening on port <code>5000</code> that it should expose</li><li>sets the <code>ASPNETCORE_URLS</code> Environment Variable</li><li>tells Docker what to execute when our App is run</li></ul><p>This is a fairly generic template for building a .NET Core multi-project App which typically only requires changing the <strong>WORKDIR</strong> to point to your Solutions <strong>Host Project</strong>:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/code-02.png" alt=""></p><p>The primary config changes you&#39;ll need to make are in <code>/deploy-env.sh</code> which contains public deployment and project-specific info. Here you&#39;ll want to change <code>AWS_DEFAULT_REGION</code> with the AWS region where your ECS Service is located. You&#39;ll also need to change <code>AWS_VIRTUAL_HOST</code> with your <code>VIRTUAL_HOST</code>:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/code-03.png" alt=""></p><h3 id="ecs-task-definition-json" tabindex="-1">ECS task-definition.json <a class="header-anchor" href="#ecs-task-definition-json" aria-hidden="true">#</a></h3><p>The <code>task-definition.json</code> is specific to AWS ECS which lets you declaratively define an atomic collection of Docker Containers ECS should run when it deploys this &quot;Task&quot;. It&#39;s essentially a thin wrapper around <a href="https://docs.docker.com/engine/reference/run/" target="_blank" rel="noopener noreferrer">docker run</a> where most features can be easily mapped to its command-line switches.</p><p>The <code>task-definition.json</code> is where we tell ECS what Docker Containers our App needs. Here in addition to our Docker App we also need an instance of <code>redis:3.2</code> that&#39;s made available to our App via Docker&#39;s <code>--link</code> feature which lets us connect to the redis-server instance using the <code>ecsdemo-redisgeo-redis</code> Hostname that we make available to our App via the <code>REDIS_HOST</code> Environment variable:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/code-04.png" alt=""></p><h2 id="configure-support-for-ssl" tabindex="-1">Configure support for SSL <a class="header-anchor" href="#configure-support-for-ssl" aria-hidden="true">#</a></h2><p>If you want to host your .NET Core Apps under SSL you&#39;ll need to include some additional information in your deployment scripts that will be passed to the <a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion" target="_blank" rel="noopener noreferrer">docker-letsencrypt-nginx-proxy-companion</a> container which is a run as a companion Docker container to <a href="https://github.com/jwilder/nginx-proxy" target="_blank" rel="noopener noreferrer">nginx-proxy</a> which will automate the creation/renewal of Lets Encrypt SSL Certificates and the necessary nginx configuration to redirect HTTP Requests to SSL Requests which are &quot;SSL terminated&quot; at the nginx reverse proxy and proxied as HTTP to your downstream .NET Core App.</p><p>Instead of starting with <code>redis-geo</code> you&#39;ll want to start with the deployment scripts in <a href="https://github.com/ServiceStack/sharpscript" target="_blank" rel="noopener noreferrer">/ServiceStack/sharpscript</a> which contain a working example of a .NET Core App hosted under SSL at <a href="https://sharpscript.net" target="_blank" rel="noopener noreferrer">https://sharpscript.net</a>.</p><p>Essentially your <a href="https://github.com/ServiceStack/sharpscript/blob/master/deploy-envs.sh" target="_blank" rel="noopener noreferrer">deploy-envs.sh</a> deployment configuration script needs to include <code>LETSENCRYPT_HOST</code> and <code>LETSENCRYPT_EMAIL</code> variables:</p><div class="language-bash"><pre><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># set environment variables used in deploy.sh and AWS task-definition.json:</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMAGE_NAME</span><span class="token operator">=</span>netcoreapps-sharpscript
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMAGE_VERSION</span><span class="token operator">=</span>latest

<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_DEFAULT_REGION</span><span class="token operator">=</span>us-east-1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_ECS_CLUSTER_NAME</span><span class="token operator">=</span>default
<span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_VIRTUAL_HOST</span><span class="token operator">=</span>sharpscript.net
<span class="token builtin class-name">export</span> <span class="token assign-left variable">LETSENCRYPT_HOST</span><span class="token operator">=</span><span class="token variable">$AWS_VIRTUAL_HOST</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">LETSENCRYPT_EMAIL</span><span class="token operator">=</span>team@servicestack.net
</code></pre></div><p>The only other change required is to pass these environment variables to your App&#39;s Docker container defined in <a href="https://github.com/ServiceStack/sharpscript/blob/master/scripts/task-definition.json" target="_blank" rel="noopener noreferrer">task-definition.json</a>:</p><div class="language-json"><pre><code><span class="token punctuation">{</span>
    <span class="token property">&quot;family&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${ECS_TASK}&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;networkMode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bridge&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;containerDefinitions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${AWS_ECS_REPO_DOMAIN}/\${IMAGE_NAME}:\${IMAGE_VERSION}&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${IMAGE_NAME}&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;cpu&quot;</span><span class="token operator">:</span> <span class="token number">128</span><span class="token punctuation">,</span>
            <span class="token property">&quot;memory&quot;</span><span class="token operator">:</span> <span class="token number">256</span><span class="token punctuation">,</span>
            <span class="token property">&quot;essential&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token property">&quot;portMappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;containerPort&quot;</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hostPort&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;environment&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VIRTUAL_HOST&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${AWS_VIRTUAL_HOST}&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;LETSENCRYPT_HOST&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${LETSENCRYPT_HOST}&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;LETSENCRYPT_EMAIL&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${LETSENCRYPT_EMAIL}&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Otherwise all other deployment scripts remain the same as a normal ECS .NET Core Docker App, the primary difference being that after it&#39;s deployed by AWS ECS, it triggers the nginx-proxy-companion to retrieve and auto-configure an SSL Certificate from <a href="https://letsencrypt.org" target="_blank" rel="noopener noreferrer">Lets Encrypt</a> for the App&#39;s external domain defined in <code>LETSENCRYPT_HOST</code> which it registers with nginx to enable its SSL-terminated <code>https</code> support for that domain.</p><h2 id="create-project-in-travis-ci" tabindex="-1">Create project in Travis-CI <a class="header-anchor" href="#create-project-in-travis-ci" aria-hidden="true">#</a></h2><p>After making the necessary changes in <code>/deploy-env.sh</code> we can register our project in <strong>Travis CI</strong>, fortunately for us Travis&#39;s UX is streamlined making this effortless. Start by clicking on <strong>Sign Up</strong> button on Travis&#39;s home page <a href="https://travis-ci.org" target="_blank" rel="noopener noreferrer">https://travis-ci.org</a>:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/travis-01.png" alt=""></p><p>Then click on the <code>+</code> link next to <strong>My Repositories</strong>:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/travis-02.png" alt=""></p><p>This takes you to your Github Profile view where you just need to click on the the switch icon next to your <strong>redis-geo fork</strong>, e.g:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/travis-03.png" alt=""></p><h3 id="ci-environment-variables" tabindex="-1">CI Environment Variables <a class="header-anchor" href="#ci-environment-variables" aria-hidden="true">#</a></h3><p>After enabling your project it will appear in your repositories list. Here we need to click on the <strong>Settings</strong> Menu Item in the <strong>More Options</strong> drop down menu in order to provide Travis the sensitive <code>ecsDemoUser</code> credentials that we don&#39;t want to include in a public Github Repository. At a minimum you&#39;ll need to add Environment variables for the <code>ecsDemoUser</code> IAM User you copied above:</p><ul><li><code>AWS_ACCOUNT_NUMBER</code></li><li><code>AWS_ACCESS_KEY_ID</code></li><li><code>AWS_SECRET_ACCESS_KEY</code></li></ul><p>The <strong>Settings</strong> page is where you can define any sensitive information you want your Docker App to have access to. E.g. although it&#39;s not needed for this Demo you can specify your <code>SERVICESTACK_LICENSE</code> here where its inject into your Docker App with the <strong>&quot;environment&quot;</strong> Key/Value list in your projects <code>task-definition.json</code>. If your App requires a lot of confidential information it can be easier to instead register a connection string to a <a href="https://docs.servicestack.net/appsettings" target="_blank" rel="noopener noreferrer">Remote AppSettings data source</a>, that way you can have a centralized location for managing the keys and connection strings for all your Apps.</p><p><img src="https://docs.servicestack.net/images/aws/ecs/travis-04.png" alt=""></p><p>If it&#39;s not on hand, you can get the <code>AWS_ACCOUNT_NUMBER</code> for your <code>ecsDemoUser</code> from the number embedded in its <strong>User ARN</strong>:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/travis-05.png" alt=""></p><p>After adding your <code>ecsDemoUser</code> credentials above, commit and push your changes to <code>deploy-env.sh</code> in order to trigger a new <strong>Travis CI</strong> build. If you&#39;ve previously committed the changes you can click <strong>Restart build</strong> to rerun the build using your latest Environment Variables. This will trigger a new build which if everything is in place should result in a successful green build:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/travis-06.png" alt=""></p><h2 id="inspect-aws-container-service" tabindex="-1">Inspect AWS Container Service <a class="header-anchor" href="#inspect-aws-container-service" aria-hidden="true">#</a></h2><p>Now we can go back into <strong>EC2 Container Service</strong> and have a look at what the generic <code>deploy.sh</code> script created for us. Clicking the <strong>Repositories</strong> tab will display your Apps <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_Console_Repositories.html" target="_blank" rel="noopener noreferrer">private ECR Repository</a> which contains a list of all Docker Images that were deployed to ECS with the one that&#39;s currently used by the running Docker Container, tagged with the <strong>latest</strong> Image tag:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/ecs-06.png" alt=""></p><p>In the <strong>Clusters</strong> tab you&#39;ll see that your <strong>default</strong> Cluster contains an <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html" target="_blank" rel="noopener noreferrer">ECS Service</a> aptly named <code>ecsdemo-redisgeo-service</code>:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/ecs-07.png" alt=""></p><p>The <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html" target="_blank" rel="noopener noreferrer">ECS Service</a> is what manages your running Tasks where if your Docker App goes down for whatever reason, the Service will restart new Task Instances based on its <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_defintions.html" target="_blank" rel="noopener noreferrer">Task Definition</a> until the <strong>Desired count</strong> of instances is reached.</p><p><img src="https://docs.servicestack.net/images/aws/ecs/ecs-08.png" alt=""></p><h3 id="view-list-of-running-docker-containers" tabindex="-1">View list of running Docker Containers <a class="header-anchor" href="#view-list-of-running-docker-containers" aria-hidden="true">#</a></h3><p>If your Service contains a <strong>RUNNING</strong> Task that means your time here was a success. We can further verify that&#39;s everything&#39;s in order by SSH&#39;ing back into our EC2 Instance and running <code>docker ps</code> to see our running Docker Containers:</p><p><img src="https://docs.servicestack.net/images/aws/ecs/ssh-03.png" alt=""></p><p>Where we should see <strong>4 running</strong> Docker Containers:</p><ol><li>nginx-proxy</li><li>Our .NET Core Docker App</li><li>redis-server</li><li>AWS ECS agent</li></ol><h2 id="problems-with-the-task-not-running" tabindex="-1">Problems with the task not running <a class="header-anchor" href="#problems-with-the-task-not-running" aria-hidden="true">#</a></h2><p>If you don&#39;t have a <strong>RUNNING</strong> Task then you might need to <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/troubleshooting.html" target="_blank" rel="noopener noreferrer">restart the ECS container agent</a> by SSH&#39;ing into the EC2 Instance and running the commands below:</p><div class="language-"><pre><code>[ec2-user ~]$ sudo stop ecs
ecs stop/waiting
[ec2-user ~]$ sudo start ecs
ecs start/running, process 26119
</code></pre></div><p>If that still doesn&#39;t work you should see if any of the containers are stopping shortly after they have started. A good way of doing this is to run <code>docker ps -a</code> which will show you all the containers that have started (without the -a, it only shows the currently running ones). If you see that some are exiting with a code that is not 0, then you may have a problem with that container. Run that container using <code>docker run</code> using its image name and omitting the -d flag. For example:</p><div class="language-"><pre><code>docker run 473481601643.dkr.ecr.ap-southeast-2.amazonaws.com/netcoreapps-redisgeo:latest
</code></pre></div><p>That will run the container and show its output, which might give you some indication of the problem.</p><h2 id="_8-play-your-deployed-net-core-docker-app" tabindex="-1">8. Play your deployed .NET Core Docker App! <a class="header-anchor" href="#_8-play-your-deployed-net-core-docker-app" aria-hidden="true">#</a></h2><p>With all the pieces in place we can visit our virtual host <a href="http://redisgeo.netcore.io" target="_blank" rel="noopener noreferrer">http://ecsdemo.netcore.io</a> to see the fruits of our Labor - our .NET Core Docker App, alive!</p><p><a href="http://redisgeo.netcore.io" target="_blank" rel="noopener noreferrer"><img src="https://docs.servicestack.net/images/aws/ecs/app-01.png" alt=""></a></p><h2 id="things-to-try" tabindex="-1">Things to try <a class="header-anchor" href="#things-to-try" aria-hidden="true">#</a></h2><h3 id="_1-make-a-change-to-your-app" tabindex="-1">1. Make a change to your App <a class="header-anchor" href="#_1-make-a-change-to-your-app" aria-hidden="true">#</a></h3><p>With your .NET Core Docker mission officially a success the first thing you&#39;re going to want to do is to commit a change to your fork whilst watching your <strong>Travis CI</strong> bot working away so you can see your Continuous Docker deployments in action \u{1F603}</p><h3 id="_2-go-through-this-tutorial-again" tabindex="-1">2. Go through this tutorial again <a class="header-anchor" href="#_2-go-through-this-tutorial-again" aria-hidden="true">#</a></h3><p>If you&#39;ve stuttered hazily through parts of this tutorial we recommend going through it again from scratch as things should become a lot clearer and faster the next time around. After doing this a few times everything will appear intuitive and you won&#39;t need to refer to this tutorial again.</p><h3 id="_3-copy-the-build-scripts-to-dockerize-own-net-core-apps" tabindex="-1">3. Copy the build scripts to Dockerize own .NET Core Apps <a class="header-anchor" href="#_3-copy-the-build-scripts-to-dockerize-own-net-core-apps" aria-hidden="true">#</a></h3><p>Customizing the deploy scripts to your own Apps will help familiarize yourself with Docker and identify the areas which are customizable.</p><h3 id="_4-exec-build-scripts-to-create-and-run-your-docker-app-locally" tabindex="-1">4. Exec build scripts to Create and Run your Docker App locally <a class="header-anchor" href="#_4-exec-build-scripts-to-create-and-run-your-docker-app-locally" aria-hidden="true">#</a></h3><p>Install <a href="https://docs.docker.com/engine/installation/mac/" target="_blank" rel="noopener noreferrer">Docker for Mac</a> or <a href="https://docs.docker.com/engine/installation/windows/" target="_blank" rel="noopener noreferrer">Docker for Windows</a> and try building and running the Docker Images locally. Since you&#39;re running locally you&#39;ll need to set any required <strong>Travis CI</strong> Environment Variables then have a look at translating what ECS does with its <code>task-definition.json</code> into docker commands. This example is a little tricky due to the use of Docker&#39;s <code>--link</code> feature but with some trial and error and the <a href="https://docs.docker.com/engine/reference/run/" target="_blank" rel="noopener noreferrer">Docker run reference</a> to guide you, you&#39;ll have your Docker App running locally - acquainting you with one of Docker&#39;s killer features!</p>__VP_STATIC_END__`,66),C=[i,c,l,p,h,d,u,g,k,w,m,y,f,v,b];function S(_,A,E,x,I,T){return r(),s("div",null,C)}var N=n(a,[["render",S]]);export{R as __pageData,N as default};
